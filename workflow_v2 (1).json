{
  "name": "workflow_v2",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "26dfb1d8-9d0d-411a-b579-17cf041ca9ff",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "jsCode": "// Get all incoming items from previous nodes\nconst items = $input.all();\n\nreturn items.map(item => {\n  const data = item.json;\n\n  // 1. Remove null or undefined values\n  Object.keys(data).forEach(key => {\n    if (data[key] === null || data[key] === undefined) {\n      delete data[key];\n    }\n  });\n\n  // 2. Standardize text fields\n  if (data.text) {\n    data.text = data.text.trim();\n  }\n\n  if (data.description) {\n    data.description = data.description\n      .trim()\n      .replace(/\\s+/g, ' ');\n  }\n\n  // 3. Add cleaned timestamp\n  data.cleaned_date = new Date().toISOString();\n\n  // Return cleaned item\n  return { json: data };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1568,
        512
      ],
      "id": "207ba97d-2161-4129-82d8-c7d5cb2539fa",
      "name": "Code in JavaScript",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "https://datasets-server.huggingface.co/rows",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "dataset",
              "value": "KevinSpaghetti/cadec"
            },
            {
              "name": "config",
              "value": "default"
            },
            {
              "name": "split",
              "value": "train"
            },
            {
              "name": "offset",
              "value": "0"
            },
            {
              "name": "length",
              "value": "80"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        672,
        224
      ],
      "id": "f3ba08b6-3cad-4071-b872-080998303cc5",
      "name": "Agent 1: Clinical Protocol Analyzer"
    },
    {
      "parameters": {
        "url": "https://www.fda.gov/AboutFDA/ContactFDA/StayInformed/RSSFeeds/MedWatch/rss.xml",
        "options": {
          "response": {
            "response": {
              "responseFormat": "text",
              "outputPropertyName": "data_xml"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        224,
        416
      ],
      "id": "c525c82b-8650-4312-bd30-46f7c77224f6",
      "name": "Agent 2 (Platform Data Orchestrator)",
      "executeOnce": false
    },
    {
      "parameters": {
        "url": "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "db",
              "value": "pubmed"
            },
            {
              "name": "id",
              "value": "39876543,39876542,39876541,39876540,39876539,39876538,39876537,39876536,39876535,39876534,39876533,39876532,39876531,39876530,39876529,38508272,38508271,38508270,38508269,38508268,38508267,38508266,38508265,38508264,38508263,38508262,38508261,38508260,38508259,38508258"
            },
            {
              "name": "retmode",
              "value": "json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        672,
        608
      ],
      "id": "14b0ca38-4518-4f74-af3f-344a99de6c4b",
      "name": "Agent 3 (Trial Performance Intelligence)"
    },
    {
      "parameters": {
        "jsCode": "const collectedAt = new Date().toISOString();\n\n// Hugging Face /rows response shape:\n// { rows: [ { row: { text, ade, term_PT, ... }, ... }, ... ] }\n\nconst rows = items?.[0]?.json?.rows || [];\nconst out = [];\n\nfor (let i = 0; i < rows.length; i++) {\n  const r = rows[i]?.row || {};\n\n  const text = (r.text ?? \"\").toString().trim();\n  const ade = (r.ade ?? \"\").toString().trim();\n  const termPT = (r.term_PT ?? \"\").toString().trim();\n\n  // Basic quality filter\n  if (!text) continue;\n\n  out.push({\n    json: {\n      record_id: `CADEC-${i + 1}`,\n      source: \"cadec_huggingface\",\n      event_term: termPT || ade || \"unknown\",\n      meddra_code: null,\n      severity: \"unknown\",\n      patient_age: null,\n      sex: null,\n      drug_name: null,\n      indication: null,\n      raw_text: text,\n      event_date: null,\n      url: \"https://huggingface.co/datasets/KevinSpaghetti/cadec\",\n      collected_at: collectedAt,\n\n      // Optional: keep original fields (helps debugging + documentation)\n      cadec_ade: ade || null,\n      cadec_term_pt: termPT || null\n    }\n  });\n}\n\n// Keep your record count clean (optional cap)\nreturn out.slice(0, 80);\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        224
      ],
      "id": "5a524997-4691-4365-b550-46aedd175767",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "dataPropertyName": "data_xml",
        "options": {}
      },
      "type": "n8n-nodes-base.xml",
      "typeVersion": 1,
      "position": [
        448,
        416
      ],
      "id": "c7ad4717-d111-43ed-8d2a-d8f05c7e3ae6",
      "name": "XML"
    },
    {
      "parameters": {
        "fieldToSplitOut": "rss.channel.item",
        "include": "allOtherFields",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        672,
        416
      ],
      "id": "1596fb1b-c0a3-4d95-9254-f4cac1199c5d",
      "name": "Split Out"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        3264,
        944
      ],
      "id": "03c223f3-b3c5-4ea1-826d-a5a7b06cc67b",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1120,
        496
      ],
      "id": "728218de-9dbe-49bd-a3e5-e1845d80d758",
      "name": "Merge"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "responses": {
          "values": [
            {
              "content": "=Analyze this adverse drug reaction report and provide a structured assessment:\n\nREPORT TEXT:\n{{$json.raw_text}}\n\nPATIENT INFO:\n- Drug: {{$json.drug_name}}\n- Event: {{$json.event_term}}\n\nPlease provide:\n1. SEVERITY_SCORE (1-5, where 5 is life-threatening)\n2. MEDICAL_CATEGORY (cardiac/neurological/dermatological/gastrointestinal/respiratory/other)\n3. URGENCY_LEVEL (immediate/urgent/monitor/routine)\n4. RECOMMENDED_ACTION (specific next steps)\n5. CONFIDENCE_LEVEL (high/medium/low)\n\nReturn as JSON format."
            }
          ]
        },
        "builtInTools": {},
        "options": {
          "maxTokens": 500,
          "textFormat": {
            "textOptions": {
              "type": "json_object"
            }
          },
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        1792,
        512
      ],
      "id": "1cd673e6-2d96-423e-90eb-dfa420e999aa",
      "name": "Message a model",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "openAiApi": {
          "id": "Rk4VRhv0ytHigrw0",
          "name": "OpenAi account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.ai_severity_score}}",
                    "rightValue": 4,
                    "operator": {
                      "type": "number",
                      "operation": "gte"
                    },
                    "id": "4065a19d-dd90-4390-bc07-372ce5d998a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "\"Critical\""
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "2b55badf-03eb-4b53-baf7-f278f7d48c4e",
                    "leftValue": "={{$json.ai_urgency}}",
                    "rightValue": "=urgent",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "\"Urgent\""
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "cd953a2d-e524-414d-a36c-94745347456e",
                    "leftValue": "={{$json.ai_urgency}}",
                    "rightValue": "monitor",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "\"Monitor\""
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "66aa0033-f2f3-4a19-8c16-e760ec6e3b26",
                    "leftValue": "",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "\"Routine\""
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        2816,
        688
      ],
      "id": "a3c112da-2d4d-4996-9eb1-22984666c525",
      "name": "Switch"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://discord.com/api/webhooks/1469500587052630190/9EjlKboKV19mylgCtOt-0og7WtxfXhy8nRo0DIiEIGG6xw0SeceOiunjJj5wVVgOUuDN",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": \"ðŸš¨ CRITICAL ADVERSE EVENT\\n\\nSeverity: {{ $json.ai_severity_score }}/5\\nCategory: {{ $json.ai_category }}\\n\\nAction: {{ $json.ai_action }}\\n\\nConfidence: {{ $json.ai_confidence }}\\n\\nâš¡ IMMEDIATE REVIEW REQUIRED\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3264,
        448
      ],
      "id": "5d105999-987e-4c10-bcf4-bd64d1c63ab4",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://discord.com/api/webhooks/1469500587052630190/9EjlKboKV19mylgCtOt-0og7WtxfXhy8nRo0DIiEIGG6xw0SeceOiunjJj5wVVgOUuDN",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $json.content }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3264,
        752
      ],
      "id": "934adfd2-affe-42bb-8a21-5872d7077646",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "jsCode": "// Enhanced AI analysis - PRESERVE ALL ORIGINAL FIELDS + ENRICH\nconst items = $input.all();\nconst originalItems = $('Code in JavaScript').all();\n\nconsole.log(`Processing ${items.length} items for enrichment`);\nconsole.log(`Original items available: ${originalItems.length}`);\n\nreturn items.map((item, index) => {\n  const data = item.json;\n  \n  // âœ… GET ORIGINAL DATA from \"Code in JavaScript\" node (before AI)\n  const originalData = originalItems[index]?.json || {};\n  \n  // Parse AI response\n  let aiAnalysis = {};\n  try {\n    if (data.output && data.output[0] && data.output[0].content && data.output[0].content[0]) {\n      const textContent = data.output[0].content[0].text;\n      aiAnalysis = {\n        severity_score: textContent.SEVERITY_SCORE || 0,\n        medical_category: textContent.MEDICAL_CATEGORY || \"unknown\",\n        urgency_level: textContent.URGENCY_LEVEL || \"routine\",\n        recommended_action: textContent.RECOMMENDED_ACTION || \"Review manually\",\n        confidence_level: textContent.CONFIDENCE_LEVEL || \"low\"\n      };\n    } else {\n      aiAnalysis = {\n        severity_score: 0,\n        medical_category: \"unknown\",\n        urgency_level: \"routine\",\n        recommended_action: \"Review manually - AI parse failed\",\n        confidence_level: \"low\"\n      };\n    }\n  } catch (e) {\n    aiAnalysis = {\n      severity_score: 0,\n      medical_category: \"unknown\",\n      urgency_level: \"routine\",\n      recommended_action: \"Review manually - error\",\n      confidence_level: \"low\"\n    };\n  }\n  \n  // Detect source\n  const source = originalData.source || 'unknown';\n  \n  // âœ… ADD ENRICHMENT based on source\n  let sourceType = '';\n  let sourceSummary = '';\n  let description = '';\n  \n  if (source.includes('cadec')) {\n    sourceType = 'Patient Report';\n    sourceSummary = `Patient-reported: ${originalData.event_term || 'symptoms'}`;\n    description = `Patient reported ${originalData.event_term || 'adverse event'}: ${originalData.raw_text?.substring(0, 150) || ''}`;\n  } else if (source === 'pubmed') {\n    sourceType = 'Research Literature';\n    sourceSummary = `Research: ${originalData.pubmed_title?.substring(0, 80) || 'Article'}`;\n    description = `${originalData.pubmed_title || 'Research article'}. Journal: ${originalData.pubmed_journal || 'Unknown'}. Authors: ${originalData.pubmed_authors || 'Not listed'}.`;\n  } else if (source.includes('fda') || source.includes('medwatch')) {\n    sourceType = 'FDA Regulatory Alert';\n    sourceSummary = `FDA Safety Alert: ${originalData.fda_alert_title?.substring(0, 80) || 'Alert'}`;\n    description = `FDA: ${originalData.fda_alert_title || 'Safety alert'}`;\n  }\n  \n  // âœ… MERGE: Keep ALL original fields + add AI analysis + add enrichment\n  const enrichedData = {\n    ...originalData,  // âœ… All original fields\n    \n    // Add enrichment\n    source_type: sourceType,\n    source_summary: sourceSummary,\n    description: description,\n    \n    // Add source-specific fields\n    cadec_patient_description: source.includes('cadec') ? originalData.raw_text : undefined,\n    cadec_event: source.includes('cadec') ? originalData.event_term : undefined,\n    \n    // Add AI Analysis\n    ai_severity_score: aiAnalysis.severity_score,\n    ai_category: aiAnalysis.medical_category,\n    ai_urgency: aiAnalysis.urgency_level,\n    ai_action: aiAnalysis.recommended_action,\n    ai_confidence: aiAnalysis.confidence_level,\n    ai_processed_at: new Date().toISOString()\n  };\n  \n  // Remove undefined values\n  Object.keys(enrichedData).forEach(key => {\n    if (enrichedData[key] === undefined) {\n      delete enrichedData[key];\n    }\n  });\n  \n  if (index === 0) {\n    console.log('âœ… Sample enriched output:', JSON.stringify({\n      record_id: enrichedData.record_id,\n      source: enrichedData.source,\n      source_type: enrichedData.source_type,\n      pubmed_title: enrichedData.pubmed_title,\n      ai_severity_score: enrichedData.ai_severity_score\n    }, null, 2));\n  }\n  \n  return { json: enrichedData };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2592,
        608
      ],
      "id": "505270d1-9ddd-4d5f-824e-613631a3a597",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3040,
        944
      ],
      "id": "c13fdad4-e021-4f92-a079-4d7f00e7b457",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsCode": "// Get all urgent items\nconst items = $input.all();\n\nif (items.length === 0) {\n  return [{\n    json: {\n      content: \"âœ… No urgent cases detected.\"\n    }\n  }];\n}\n\n// Build compact summary message\nlet msg = `ðŸš¨ **URGENT ALERTS** (${items.length} total)\\n`;\nmsg += `â° ${new Date().toLocaleString()}\\n\\n`;\nmsg += `**Top 5 Critical Cases:**\\n`;\n\n// Get top 5 by severity\nconst top = items\n  .sort((a, b) => (b.json.ai_severity_score || 0) - (a.json.ai_severity_score || 0))\n  .slice(0, 5);\n\n// Format each case\ntop.forEach((item, i) => {\n  const d = item.json;\n  msg += `${i+1}. Severity ${d.ai_severity_score}/5 | ${d.ai_category} | ${d.ai_action}\\n`;\n});\n\nif (items.length > 5) {\n  msg += `\\n+${items.length - 5} more cases require review`;\n}\n\nmsg += `\\n\\nâš¡ **REVIEW REQUIRED**`;\n\n// CRITICAL: Return with content field\nreturn [{ \n  json: { \n    content: msg \n  } \n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3040,
        752
      ],
      "id": "9491dd4c-325e-4d99-bfc5-a37b1d3138b8",
      "name": "Create Discord Summary"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "b2f9cff6-a89a-4c2e-b962-c921323ab22c",
              "leftValue": "={{ $json.error_detected }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2368,
        512
      ],
      "id": "ef722929-13d9-4c39-8739-ebd94b95b42a",
      "name": "If"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://discord.com/api/webhooks/1469500587052630190/9EjlKboKV19mylgCtOt-0og7WtxfXhy8nRo0DIiEIGG6xw0SeceOiunjJj5wVVgOUuDN",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $json.error }}\nTime: {{ $now.toISO() }}\n"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2592,
        416
      ],
      "id": "a2ebc6d5-b529-40d7-87fe-479c512ef789",
      "name": "Send Error Alert to Discord",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "fromEmail": "manishasahu2055@gmail.com",
        "toEmail": "manishasahu2055@gmail.com",
        "subject": "=FDA Adverse Event Report - {{ $now.format('-MM-DD HH:mm') }}",
        "emailFormat": "text",
        "options": {
          "attachments": "data"
        }
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        3488,
        944
      ],
      "id": "728c4757-f029-423c-a516-d0ac086e0cb8",
      "name": "Send email",
      "webhookId": "6c426765-44a9-4f9f-bebb-886ad036217b",
      "credentials": {
        "smtp": {
          "id": "IkszwQNrktkunA9q",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3040,
        512
      ],
      "id": "bc23ff8c-6570-4318-a373-92c091211cf5",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        3488,
        512
      ],
      "id": "ca998b3e-8a23-404a-b6eb-f6ce0db44ce4",
      "name": "Wait",
      "webhookId": "8fcd72c6-c110-46a0-99b5-dae85f77aeea"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => {\n  const data = item.json;\n  \n  // Check if we have VALID AI output\n  const hasValidOutput = !!(\n    data.output && \n    data.output[0] && \n    data.output[0].content && \n    data.output[0].content[0] &&\n    data.output[0].content[0].text\n  );\n  \n  const hasError = !hasValidOutput;\n  \n  console.log('Error Detector:', {\n    hasValidOutput,\n    hasError,\n    hasOutput: !!data.output\n  });\n  \n  return {\n    json: {\n      ...data,\n      error_detected: hasError,\n      // Debug fields\n      debug_hasValidOutput: hasValidOutput,\n      debug_hasError: hasError\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2144,
        512
      ],
      "id": "ceba823d-713d-443b-a36e-20594b2544dc",
      "name": "Error Detector"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "c4e3e139-affc-40e5-a550-11c1b30540fe",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        416
      ],
      "id": "62d2434a-6039-4a55-a60c-f51797a1335b",
      "name": "Webhook",
      "webhookId": "c4e3e139-affc-40e5-a550-11c1b30540fe"
    },
    {
      "parameters": {
        "jsCode": "// Dynamic limiting with SHUFFLE to mix all sources\nconst webhookData = $('Webhook').first().json.body || $('Webhook').first().json;\nconst requestedCount = parseInt(webhookData.record_count) || 10;\n\nconsole.log('Requested:', requestedCount, 'records');\n\n// Get all items from previous node\nconst allItems = $input.all();\n\nconsole.log('Total items available:', allItems.length);\n\n// âœ… SHUFFLE to mix CADEC, FDA, and PubMed records\nconst shuffled = allItems.sort(() => Math.random() - 0.5);\n\n// Return only requested number from shuffled array\nconst limitedItems = shuffled.slice(0, requestedCount);\n\n// Count by source\nconst sources = {};\nlimitedItems.forEach(item => {\n  const source = item.json.source || 'unknown';\n  sources[source] = (sources[source] || 0) + 1;\n});\n\nconsole.log('Returning:', limitedItems.length, 'records');\nconsole.log('Source distribution:', JSON.stringify(sources));\n\nreturn limitedItems;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        512
      ],
      "id": "07b6104f-aecf-4c7e-8c23-7ab164ace01c",
      "name": "Dynamic Limit Based on Webhook"
    },
    {
      "parameters": {
        "jsCode": "// Parse PubMed summary response to get actual article data\nconst response = items[0].json;\nconst result = response.result || {};\nconst out = [];\n\n// Get all article UIDs\nconst uids = result.uids || [];\n\nconsole.log(`Processing ${uids.length} PubMed articles`);\n\n// Process each article\nuids.forEach(uid => {\n  const article = result[uid];\n  \n  if (article && article.title) {\n    // Extract author names with proper handling\n    const authors = article.authors || [];\n    const authorNames = authors\n      .slice(0, 3)\n      .map(a => a.name)\n      .join(', ');\n    \n    const moreAuthors = authors.length > 3 ? ` +${authors.length - 3} more` : '';\n    const fullAuthors = authorNames + moreAuthors;\n    \n    // Build comprehensive raw_text\n    const rawText = `${article.title}. Published in ${article.fulljournalname || article.source || 'Unknown Journal'} (${article.pubdate || 'Date unknown'}). Authors: ${fullAuthors || 'Not specified'}.`;\n    \n    out.push({\n      json: {\n        record_id: `PUBMED-${uid}`,\n        source: 'pubmed',  // âœ… CRITICAL: Must be exactly 'pubmed'\n        event_term: article.title,  // Use title as event\n        meddra_code: null,\n        severity: 'unknown',\n        patient_age: null,\n        sex: null,\n        drug_name: null,\n        indication: null,\n        raw_text: rawText,\n        event_date: article.pubdate || null,\n        url: `https://pubmed.ncbi.nlm.nih.gov/${uid}/`,\n        collected_at: new Date().toISOString(),\n        \n        // âœ… PubMed-specific enrichment (REQUIRED for Streamlit display)\n        pubmed_id: uid,\n        pubmed_title: article.title,\n        pubmed_journal: article.fulljournalname || article.source || 'Unknown Journal',\n        pubmed_date: article.pubdate || null,\n        pubmed_authors: fullAuthors || 'Not specified',\n        pubmed_doi: article.elocationid || null,\n        pubmed_pmcid: article.pmcid || null\n      }\n    });\n  }\n});\n\nconsole.log(`âœ… Successfully parsed ${out.length} PubMed articles with full metadata`);\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        608
      ],
      "id": "5032f4d5-1c49-4613-85f4-70395ba5f13a",
      "name": "Parse PubMed Summaries"
    },
    {
      "parameters": {
        "jsCode": "// Prepare complete response for Streamlit with proper IDs and full PubMed data\nconst allRecords = $input.all();\n\n// Shuffle records to mix sources\nconst shuffled = allRecords.sort(() => Math.random() - 0.5);\n\n// Build response object\nconst response = {\n  success: true,\n  total_records: shuffled.length,\n  records: shuffled.map((item, index) => {\n    const d = item.json;\n    \n    // Generate proper record ID\n    let recordId = d.record_id || d.id || `RECORD-${index + 1}`;\n    \n    // If still generic, try to make it source-specific\n    if (recordId === 'unknown' || !recordId) {\n      const source = d.source || 'UNKNOWN';\n      if (source.includes('cadec')) {\n        recordId = `CADEC-${index + 1}`;\n      } else if (source.includes('fda') || source.includes('medwatch')) {\n        recordId = `FDA-${index + 1}`;\n      } else if (source.includes('pubmed') || source === 'pubmed') {\n        recordId = d.pubmed_id ? `PUBMED-${d.pubmed_id}` : `PUBMED-${index + 1}`;\n      } else {\n        recordId = `REC-${index + 1}`;\n      }\n    }\n    \n    return {\n      record_id: recordId,\n      source: d.source || 'unknown',\n      source_type: d.source_type || null,\n      source_summary: d.source_summary || null,\n      event_term: d.event_term || 'unknown',\n      description: d.description || null,\n      raw_text: d.raw_text || '',\n      \n      // AI Analysis\n      ai_severity_score: d.ai_severity_score || 0,\n      ai_category: d.ai_category || 'unknown',\n      ai_urgency: d.ai_urgency || 'routine',\n      ai_action: d.ai_action || 'No action specified',\n      ai_confidence: d.ai_confidence || 'low',\n      \n      // âœ… CRITICAL: Preserve ALL PubMed fields\n      pubmed_id: d.pubmed_id || null,\n      pubmed_title: d.pubmed_title || null,\n      pubmed_journal: d.pubmed_journal || null,\n      pubmed_authors: d.pubmed_authors || null,\n      pubmed_date: d.pubmed_date || null,\n      pubmed_doi: d.pubmed_doi || null,\n      \n      // CADEC fields\n      cadec_patient_description: d.cadec_patient_description || null,\n      cadec_event: d.cadec_event || null,\n      \n      // FDA fields\n      fda_alert_title: d.fda_alert_title || null,\n      fda_alert_link: d.fda_alert_link || null,\n      \n      // Metadata\n      url: d.url || null,\n      collected_at: d.collected_at || null\n    };\n  }),\n  summary: {\n    total: shuffled.length,\n    by_source: {\n      cadec: shuffled.filter(r => (r.json.source || '').includes('cadec')).length,\n      fda: shuffled.filter(r => (r.json.source || '').includes('fda') || (r.json.source || '').includes('medwatch')).length,\n      pubmed: shuffled.filter(r => r.json.source === 'pubmed').length\n    },\n    by_severity: {\n      critical: shuffled.filter(r => (r.json.ai_severity_score || 0) >= 4).length,\n      moderate: shuffled.filter(r => (r.json.ai_severity_score || 0) === 3).length,\n      mild: shuffled.filter(r => (r.json.ai_severity_score || 0) <= 2).length\n    }\n  },\n  outputs: {\n    discord_critical_sent: shuffled.filter(r => (r.json.ai_severity_score || 0) >= 4).length,\n    discord_urgent_sent: shuffled.filter(r => ['urgent', 'immediate'].includes(r.json.ai_urgency)).length > 0,\n    email_sent: true,\n    email_recipient: \"manishasahu2055@gmail.com\"\n  },\n  metadata: {\n    processed_at: new Date().toISOString()\n  }\n};\n\nconsole.log(`âœ… Prepared ${response.records.length} records for Streamlit`);\nconsole.log(`ðŸ“Š Sources: CADEC=${response.summary.by_source.cadec}, FDA=${response.summary.by_source.fda}, PubMed=${response.summary.by_source.pubmed}`);\nconsole.log(`ðŸ“„ PubMed records with titles: ${response.records.filter(r => r.pubmed_title).length}`);\n\nreturn [{ json: response }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2816,
        320
      ],
      "id": "1ae4d51f-bedb-49db-8042-1fcd5c721c23",
      "name": "Prepare Streamlit Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        3040,
        320
      ],
      "id": "a3c5cb36-6320-4d36-ba62-a50242450208",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "jsCode": "// Format FDA RSS items into proper records - Clean, professional values\nconst items = $input.all();\n\nconsole.log(`Formatting ${items.length} FDA items`);\n\nreturn items.map((item, index) => {\n  const data = item.json;\n  \n  // FDA RSS data comes in as flattened structure\n  // Extract the actual RSS item data\n  const rssItem = data['rss.channel.item'] || data;\n  \n  const title = rssItem.title || data.title || 'FDA Medical Device Safety Alert';\n  const link = rssItem.link || data.link || 'https://www.fda.gov/';\n  const description = rssItem.description || data.description || 'Medical device safety communication from FDA';\n  const pubDate = rssItem.pubDate || data.pubDate || new Date().toISOString();\n  \n  return {\n    json: {\n      record_id: `FDA-${String(index + 1).padStart(4, '0')}`,\n      source: 'fda_medwatch',\n      event_term: title,\n      raw_text: `${title}. ${description}`,\n      event_date: pubDate,\n      url: link,\n      collected_at: new Date().toISOString(),\n      \n      // FDA-specific fields\n      fda_alert_title: title,\n      fda_alert_link: link,\n      fda_pub_date: pubDate,\n      fda_description: description\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        416
      ],
      "id": "c9eba1f0-b8a2-4b0e-b193-9147897422df",
      "name": "Format FDA Data"
    }
  ],
  "pinData": {},
  "connections": {
    "Agent 1: Clinical Protocol Analyzer": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent 2 (Platform Data Orchestrator)": {
      "main": [
        [
          {
            "node": "XML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent 3 (Trial Performance Intelligence)": {
      "main": [
        [
          {
            "node": "Parse PubMed Summaries",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "XML": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Format FDA Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Send email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Dynamic Limit Based on Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Error Detector",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Discord Summary",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Prepare Streamlit Response",
            "type": "main",
            "index": 0
          },
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Discord Summary": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Send Error Alert to Discord",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Detector": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Agent 1: Clinical Protocol Analyzer",
            "type": "main",
            "index": 0
          },
          {
            "node": "Agent 2 (Platform Data Orchestrator)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Agent 3 (Trial Performance Intelligence)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dynamic Limit Based on Webhook": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse PubMed Summaries": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Prepare Streamlit Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format FDA Data": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": -1
  },
  "versionId": "34477425-88e9-4d55-a36c-60164ca04175",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f5afedc3bc65306c9471fa25da53754ccb0df5c6420f2e953f7bfc13791bc7df"
  },
  "id": "MwsGZgvBRYxzQQSV",
  "tags": []
}